{"version":3,"file":"form.es.js","sources":["../../../src/contexts/form/form.tsx"],"sourcesContent":["// Dependencies\nimport * as React from 'react';\nimport { payments } from '@square/web-sdk';\nimport type * as Square from '@square/web-sdk';\n\n// Internals\nimport { ErrorScreen } from '~/components/error-screen';\nimport { useDynamicCallback } from '~/hooks/use-dynamic-callback';\nimport type { FormContextType, FormProviderProps } from './form.types';\n\n/**\n * Internal helper that the `PaymentForm` uses to manage internal state and\n * expose access to the Web Payment SDK library.\n */\nconst FormContext = React.createContext<FormContextType>({\n  cardTokenizeResponseReceived: null as unknown as () => Promise<void>,\n  createPaymentRequest: null as unknown as Square.PaymentRequestOptions,\n  payments: null as unknown as Square.Payments,\n});\n\nfunction FormProvider({ applicationId, locationId, children, overrides, ...props }: FormProviderProps) {\n  const [instance, setInstance] = React.useState<Square.Payments>();\n  const [createPaymentRequest] = React.useState<undefined | Square.PaymentRequestOptions>(() =>\n    props.createPaymentRequest?.()\n  );\n\n  React.useEffect(() => {\n    const abortController = new AbortController();\n    const { signal } = abortController;\n\n    async function loadPayment(signal?: AbortSignal): Promise<void> {\n      await payments(applicationId, locationId, overrides).then((res) => {\n        if (res === null) {\n          throw new Error('Square Web Payments SDK failed to load');\n        }\n\n        if (signal?.aborted) {\n          return;\n        }\n\n        setInstance(res);\n\n        return res;\n      });\n    }\n\n    if (applicationId && locationId) {\n      loadPayment(signal);\n    }\n\n    return () => {\n      abortController.abort();\n    };\n  }, [applicationId, locationId]);\n\n  const cardTokenizeResponseReceived = async (rest: Square.TokenResult): Promise<void> => {\n    if (rest.errors || !props.createVerificationDetails) {\n      await props.cardTokenizeResponseReceived(rest);\n      return;\n    }\n\n    const verifyBuyerResults = await instance?.verifyBuyer(String(rest.token), props.createVerificationDetails());\n\n    await props.cardTokenizeResponseReceived(rest, verifyBuyerResults);\n  };\n\n  // Fixes stale closure issue with using React Hooks & SqPaymentForm callback functions\n  // https://github.com/facebook/react/issues/16956\n  const cardTokenizeResponseReceivedCallback = useDynamicCallback(cardTokenizeResponseReceived);\n\n  if (!applicationId || !locationId) {\n    return <ErrorScreen />;\n  }\n\n  if (!instance) return null;\n\n  const context: FormContextType = {\n    cardTokenizeResponseReceived: cardTokenizeResponseReceivedCallback,\n    createPaymentRequest,\n    payments: instance,\n  };\n\n  return <FormContext.Provider value={context}>{children}</FormContext.Provider>;\n}\n\nconst useForm = (): FormContextType => {\n  const context = React.useContext(FormContext);\n\n  if (context === undefined) {\n    throw new Error('useForm must be used within a FormProvider');\n  }\n\n  return context;\n};\n\nexport { FormContext, useForm };\nexport default FormProvider;\n"],"names":[],"mappings":"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"}