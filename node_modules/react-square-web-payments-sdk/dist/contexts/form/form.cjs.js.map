{"version":3,"file":"form.cjs.js","sources":["../../../src/contexts/form/form.tsx"],"sourcesContent":["// Dependencies\nimport * as React from 'react';\nimport { payments } from '@square/web-sdk';\nimport type * as Square from '@square/web-sdk';\n\n// Internals\nimport { ErrorScreen } from '~/components/error-screen';\nimport { useDynamicCallback } from '~/hooks/use-dynamic-callback';\nimport type { FormContextType, FormProviderProps } from './form.types';\n\n/**\n * Internal helper that the `PaymentForm` uses to manage internal state and\n * expose access to the Web Payment SDK library.\n */\nconst FormContext = React.createContext<FormContextType>({\n  cardTokenizeResponseReceived: null as unknown as () => Promise<void>,\n  createPaymentRequest: null as unknown as Square.PaymentRequestOptions,\n  payments: null as unknown as Square.Payments,\n});\n\nfunction FormProvider({ applicationId, locationId, children, overrides, ...props }: FormProviderProps) {\n  const [instance, setInstance] = React.useState<Square.Payments>();\n  const [createPaymentRequest] = React.useState<undefined | Square.PaymentRequestOptions>(() =>\n    props.createPaymentRequest?.()\n  );\n\n  React.useEffect(() => {\n    const abortController = new AbortController();\n    const { signal } = abortController;\n\n    async function loadPayment(signal?: AbortSignal): Promise<void> {\n      await payments(applicationId, locationId, overrides).then((res) => {\n        if (res === null) {\n          throw new Error('Square Web Payments SDK failed to load');\n        }\n\n        if (signal?.aborted) {\n          return;\n        }\n\n        setInstance(res);\n\n        return res;\n      });\n    }\n\n    if (applicationId && locationId) {\n      loadPayment(signal);\n    }\n\n    return () => {\n      abortController.abort();\n    };\n  }, [applicationId, locationId]);\n\n  const cardTokenizeResponseReceived = async (rest: Square.TokenResult): Promise<void> => {\n    if (rest.errors || !props.createVerificationDetails) {\n      await props.cardTokenizeResponseReceived(rest);\n      return;\n    }\n\n    const verifyBuyerResults = await instance?.verifyBuyer(String(rest.token), props.createVerificationDetails());\n\n    await props.cardTokenizeResponseReceived(rest, verifyBuyerResults);\n  };\n\n  // Fixes stale closure issue with using React Hooks & SqPaymentForm callback functions\n  // https://github.com/facebook/react/issues/16956\n  const cardTokenizeResponseReceivedCallback = useDynamicCallback(cardTokenizeResponseReceived);\n\n  if (!applicationId || !locationId) {\n    return <ErrorScreen />;\n  }\n\n  if (!instance) return null;\n\n  const context: FormContextType = {\n    cardTokenizeResponseReceived: cardTokenizeResponseReceivedCallback,\n    createPaymentRequest,\n    payments: instance,\n  };\n\n  return <FormContext.Provider value={context}>{children}</FormContext.Provider>;\n}\n\nconst useForm = (): FormContextType => {\n  const context = React.useContext(FormContext);\n\n  if (context === undefined) {\n    throw new Error('useForm must be used within a FormProvider');\n  }\n\n  return context;\n};\n\nexport { FormContext, useForm };\nexport default FormProvider;\n"],"names":["React","payments","useDynamicCallback","ErrorScreen"],"mappings":"4oBAcM,KAAA,GAAcA,EAAM,cAA+B,CACvD,6BAA8B,KAC9B,qBAAsB,KACtB,SAAU,IACZ,CAAC,EAED,WAAsB,CAAE,gBAAe,aAAY,WAAU,eAAc,GAA4B,CACrG,KAAM,CAAC,EAAU,GAAeA,EAAM,SAA0B,EAC1D,CAAC,GAAwBA,EAAM,SAAmD,IACtF,EAAM,wBACR,EAEAA,EAAM,UAAU,IAAM,CACd,KAAA,GAAkB,GAAI,iBACtB,CAAE,UAAW,EAEnB,iBAA2B,EAAqC,CAC9D,KAAMC,GAAAA,SAAS,EAAe,EAAY,CAAS,EAAE,KAAK,AAAC,GAAQ,CACjE,GAAI,IAAQ,KACJ,KAAA,IAAI,OAAM,wCAAwC,EAG1D,GAAI,IAAQ,QAIZ,SAAY,CAAG,EAER,CAAA,CACR,CACH,CAEA,MAAI,IAAiB,GACnB,EAAY,CAAM,EAGb,IAAM,CACX,EAAgB,MAAM,CAAA,CACxB,EACC,CAAC,EAAe,CAAU,CAAC,EAExB,KAAA,GAA+B,KAAO,IAA4C,CACtF,GAAI,EAAK,QAAU,CAAC,EAAM,0BAA2B,CAC7C,KAAA,GAAM,6BAA6B,CAAI,EAC7C,MACF,CAEM,KAAA,GAAqB,KAAM,IAAU,YAAY,OAAO,EAAK,KAAK,EAAG,EAAM,0BAAA,CAA2B,EAEtG,KAAA,GAAM,6BAA6B,EAAM,CAAkB,CAAA,EAK7D,EAAuCC,qBAAmB,CAA4B,EAExF,GAAA,CAAC,GAAiB,CAAC,EACrB,uBAAQC,EAAY,QAAA,IAAA,EAGtB,GAAI,CAAC,EAAiB,MAAA,MAEtB,KAAM,GAA2B,CAC/B,6BAA8B,EAC9B,uBACA,SAAU,CAAA,EAGL,MAAAH,GAAA,cAAC,EAAY,SAAZ,CAAqB,MAAO,CAAA,EAAU,CAAS,CACzD,CAEA,KAAM,GAAU,IAAuB,CAC/B,KAAA,GAAUA,EAAM,WAAW,CAAW,EAE5C,GAAI,IAAY,OACR,KAAA,IAAI,OAAM,4CAA4C,EAGvD,MAAA,EACT"}