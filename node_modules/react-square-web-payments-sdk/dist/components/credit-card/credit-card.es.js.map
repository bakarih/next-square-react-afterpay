{"version":3,"file":"credit-card.es.js","sources":["../../../src/components/credit-card/credit-card.tsx"],"sourcesContent":["// Dependencies\nimport * as React from 'react';\nimport type * as Square from '@square/web-sdk';\n\n// Internals\nimport { useForm } from '~/contexts/form';\nimport { useEventListener } from '~/hooks/use-event-listener';\nimport { LoadingCard, PayButton } from './credit-card.styles';\nimport type {\n  CreditCardBase,\n  CreditCardChildren,\n  CreditCardFunctionChildren,\n  CreditCardPayButtonProps,\n  CreditCardProps,\n} from './credit-card.types';\n\n/**\n * Renders a Credit Card Input to use in the Square Web Payment SDK, pre-styled\n * to meet Square branding guidelines.\n *\n * **_But with the option to override styles_**\n *\n * @example\n *\n * ```tsx\n * function App() {\n *   return (\n *     <SquareForm {...props}>\n *       <CreditCard />\n *     </SquareForm>\n *   );\n * }\n * ```\n */\nfunction CreditCard(props: CreditCardBase): JSX.Element;\nfunction CreditCard(props: CreditCardChildren): JSX.Element;\nfunction CreditCard(props: CreditCardFunctionChildren): JSX.Element;\nfunction CreditCard({\n  buttonProps,\n  callbacks,\n  children,\n  focus = 'cardNumber',\n  id = 'rswps-card-container',\n  includeInputLabels,\n  postalCode,\n  recalculateSize,\n  render,\n  style,\n  ...props\n}: CreditCardProps) {\n  const [card, setCard] = React.useState<Square.Card | undefined>(() => undefined);\n  const [isSubmitting, setIsSubmitting] = React.useState<boolean>(false);\n  const buttonRef = React.useRef<HTMLButtonElement>(null);\n  const { cardTokenizeResponseReceived, payments } = useForm();\n\n  const options: Square.CardOptions = React.useMemo(() => {\n    const baseOptions = {\n      includeInputLabels,\n      postalCode,\n      style,\n    };\n\n    // if a value from options is undefined delete it from the options object\n    return Object.keys(baseOptions).reduce((acc: Record<string, unknown>, key) => {\n      if (baseOptions[key as keyof typeof baseOptions] !== undefined) {\n        acc[key as string] = baseOptions[key as keyof typeof baseOptions];\n      }\n\n      return acc;\n    }, {});\n  }, [includeInputLabels, postalCode, style]);\n\n  /**\n   * Handle the on click of the Credit Card button click\n   *\n   * @param e An event which takes place in the DOM.\n   * @returns The data be sended to `cardTokenizeResponseReceived()` function, or an error\n   */\n  const handlePayment = async (e: Event) => {\n    e.stopPropagation();\n\n    if (buttonProps?.isLoading) return;\n\n    if (!card) {\n      console.warn('Credit Card button was clicked, but no Credit Card instance was found.');\n\n      return;\n    }\n\n    setIsSubmitting(true);\n\n    try {\n      const result = await card.tokenize();\n\n      if (result.status === 'OK') {\n        const tokenizedResult = await cardTokenizeResponseReceived(result);\n        return tokenizedResult;\n      }\n\n      let message = `Tokenization failed with status: ${result.status}`;\n      if (result?.errors) {\n        message += ` and errors: ${JSON.stringify(result?.errors)}`;\n\n        throw new Error(message);\n      }\n\n      console.warn(message);\n    } catch (error) {\n      console.error(error);\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  React.useEffect(() => {\n    const abortController = new AbortController();\n    const { signal } = abortController;\n\n    const start = async (signal: AbortSignal) => {\n      const card = await payments?.card(options).then((res) => {\n        if (!signal.aborted) {\n          setCard(res);\n          return res;\n        }\n\n        return null;\n      });\n\n      await card?.attach(`#${id}`);\n      if (focus) {\n        await card?.focus(focus);\n      }\n\n      if (signal.aborted) {\n        await card?.destroy();\n      }\n    };\n\n    start(signal);\n\n    return () => {\n      abortController.abort();\n    };\n  }, [payments, id]);\n\n  React.useEffect(() => {\n    if (card && focus) {\n      card.focus(focus);\n    }\n  }, [card, focus]);\n\n  if (callbacks) {\n    for (const callback of Object.keys(callbacks)) {\n      card?.addEventListener(\n        callback as Square.CardInputEventTypes,\n        (callbacks as Record<string, (event: Square.SqEvent<Square.CardInputEvent>) => void>)[callback]\n      );\n    }\n  }\n\n  if (recalculateSize) {\n    recalculateSize(card?.recalculateSize);\n  }\n\n  useEventListener({\n    listener: handlePayment,\n    type: 'click',\n    element: buttonRef,\n    options: {\n      passive: true,\n    },\n  });\n\n  const Button = ({ children, isLoading, ...props }: CreditCardPayButtonProps) => {\n    const id = 'rswp-card-button';\n    const disabled = isLoading || !card || isSubmitting;\n\n    return (\n      <PayButton\n        {...props}\n        aria-disabled={disabled}\n        css={props?.css}\n        disabled={disabled}\n        id={id}\n        ref={buttonRef}\n        type=\"button\"\n      >\n        {children ?? 'Pay'}\n      </PayButton>\n    );\n  };\n\n  return (\n    <>\n      <div {...props} data-testid=\"rswps-card-container\" id={id} style={{ minHeight: 89 }}>\n        {!card && <LoadingCard />}\n      </div>\n\n      {typeof render === 'function' ? render(Button) : <Button {...buttonProps}>{children ?? 'Pay'}</Button>}\n    </>\n  );\n}\n\nexport default CreditCard;\nexport * from './credit-card.types';\n"],"names":[],"mappings":"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"}